<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pure Go Go (v4 Live)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @tailwind base;
        @tailwind components;
        @tailwind utilities;

        .app-screen {
            @apply w-full min-h-full bg-gray-50;
            scroll-behavior: smooth;
        }
        
        .safe-area {
            @apply w-full h-full pb-24;
        }

        #bottom-nav button[data-active="true"] {
            @apply text-green-700;
        }
        #bottom-nav button[data-active="false"] {
            @apply text-gray-400 hover:text-gray-600;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-custom {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes toastIn {
            from { opacity: 0; transform: translateY(-100%); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes toastOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-100%); }
        }
        .toast-in {
            animation: toastIn 0.3s ease-out forwards;
        }
        .toast-out {
            animation: toastOut 0.3s ease-in forwards;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.3s linear;
        }
        
        #scanner-region {
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
            position: relative;
        }
        
        #scanner-region video {
            width: 100% !important;
            height: auto !important;
        }

        .scroll-snap-x {
            scroll-snap-type: x mandatory;
        }
        .scroll-snap-item {
            scroll-snap-align: center;
        }
        
        .btn {
            @apply transition duration-150 ease-in-out;
        }
        .btn:active {
            @apply transform scale-95;
        }
    </style>
</head>
<body class="bg-gray-800 flex justify-center">

    <div class="relative w-full max-w-lg min-h-screen shadow-2xl overflow-hidden bg-gray-50">

        <div id="app-toast" class="hidden fixed top-4 z-50 w-full max-w-lg px-4">
            <div id="app-toast-content" class="w-full text-center p-3 rounded-lg shadow-lg">
                Item added to cart!
            </div>
        </div>
        
        <div id="app-container" class="w-full h-full">

            <section id="loading-screen" class="app-screen flex flex-col items-center justify-center h-screen bg-white">
                <div class="flex items-center space-x-2">
                    <span class="text-5xl font-bold text-green-700">Pure</span>
                    <span class="text-5xl font-bold text-amber-500">Go Go</span>
                </div>
                <p class="text-lg text-gray-600 mt-2">Smart Shopping. Just Go.</p>
                <p class="text-green-700 mt-20 animate-pulse-custom" id="loading-text">Loading...</p>
            </section>

            <section id="home-screen" class="app-screen hidden">
                <div class="safe-area overflow-y-auto">
                    <div class="p-6 bg-white shadow">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="text-3xl font-bold text-green-700">Pure</span>
                                <span class="text-3xl font-bold text-amber-500">Go Go</span>
                            </div>
                            <img id="home-profile-img" src="" alt="Profile" class="w-10 h-10 rounded-full border-2 border-green-700 btn cursor-pointer">
                        </div>
                        <h1 class="mt-6 text-3xl font-bold text-gray-900">Welcome,</h1>
                        <p id="user-name-greeting" class="text-2xl text-green-700">Customer!</p>
                    </div>

                    <div class="px-6 mt-6">
                        <h2 class="text-xl font-semibold text-gray-800">Promotions</h2>
                        <div id="promotions-container" class="flex overflow-x-auto scroll-snap-x gap-4 mt-4 pb-2">
                        </div>
                    </div>
                    
                    <div class="px-6 mt-8">
                        <h2 class="text-xl font-semibold text-gray-800">Browse Categories</h2>
                        <div id="categories-container" class="grid grid-cols-3 gap-4 mt-4">
                        </div>
                    </div>
                </div>
            </section>

            <section id="scan-screen" class="app-screen hidden bg-white">
                <div class="safe-area overflow-y-auto p-6">
                    <h1 class="text-3xl font-bold text-gray-900">Scan & Add</h1>
                    <div id="scanner-region" class="w-full aspect-video bg-gray-800 rounded-lg mt-6 flex items-center justify-center">
                        <span class="text-gray-400">Tap to start scanner</span>
                    </div>
                    <button id="scanner-toggle-btn" class="w-full py-3 bg-green-700 text-white font-semibold rounded-lg shadow btn mt-4">Start Scanner</button>

                    <p class="text-center text-gray-500 my-4">OR</p>
                    
                    <div class="space-y-4">
                        <h2 class="text-lg font-semibold text-gray-800">Simulate Scan (Prototype)</h2>
                        <input id="barcode-input" type="text" placeholder="Enter barcode (e.g., 4800016001010)" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white">
                        <button id="find-item-btn" class="w-full py-3 bg-green-700 text-white font-semibold rounded-lg shadow btn">Find Item</button>
                        <p id="scan-error" class="text-red-500 text-sm text-center hidden">Item not found. Try another barcode.</p>
                    </div>
                    
                    <div id="product-info-card" class="hidden mt-6 border border-gray-200 rounded-lg shadow-lg fade-in bg-white">
                        <div class="flex p-4 space-x-4">
                            <img id="product-img" src="" alt="Product Image" class="w-24 h-24 rounded-md bg-gray-100 object-cover">
                            <div class="flex-1">
                                <h3 id="product-name" class="font-semibold text-lg text-gray-900"></h3>
                                <div class="flex items-baseline space-x-2">
                                    <span id="product-price" class="text-xl font-bold text-green-700"></span>
                                    <span id="product-discount" class="text-sm font-semibold text-red-500"></span>
                                </div>
                            </div>
                        </div>
                        <button id="add-to-cart-btn" class="w-full py-3 bg-amber-500 text-green-900 font-bold rounded-b-lg btn">Add to Cart</button>
                    </div>

                    <div class="mt-6">
                        <h3 class="text-lg font-semibold text-gray-800">Quick Add (Demo)</h3>
                        <div class="grid grid-cols-2 gap-4 mt-2">
                            <button class="quick-add-btn text-left p-3 bg-gray-100 rounded-lg btn" data-barcode="4800016001010">Purefoods Corned Beef</button>
                            <button class="quick-add-btn text-left p-3 bg-gray-100 rounded-lg btn" data-barcode="4800016003014">Nissin Yakisoba</button>
                            <button class="quick-add-btn text-left p-3 bg-gray-100 rounded-lg btn" data-barcode="4801981123456">Coke 1.5L</button>
                            <button class="quick-add-btn text-left p-3 bg-gray-100 rounded-lg btn" data-barcode="4800016005018">Gardenia Bread</button>
                        </div>
                    </div>

                </div>
            </section>

            <section id="cart-screen" class="app-screen hidden bg-white">
                <div class="safe-area overflow-y-auto p-6">
                    <div class="flex justify-between items-center">
                        <h1 class="text-3xl font-bold text-gray-900">My Cart</h1>
                        <button id="clear-cart-btn" class="hidden text-sm text-red-500 btn">Clear Cart</button>
                    </div>
                    
                    <div id="cart-items-list" class="mt-6 space-y-4">
                        <div id="empty-cart-msg" class="text-center py-10">
                            <span class="text-5xl">üõí</span>
                            <p class="text-lg text-gray-500 mt-4">Your cart is empty.</p>
                            <button id="empty-cart-scan-btn" class="mt-6 px-6 py-3 bg-green-700 text-white font-semibold rounded-lg btn">Start Scanning</button>
                        </div>
                    </div>

                    <div id="cart-summary-block" class="hidden mt-8">
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800">Order Summary</h3>
                            <div class="space-y-2 mt-4">
                                <div class="flex justify-between text-gray-600">
                                    <span>Subtotal</span>
                                    <span id="summary-subtotal">P0.00</span>
                                </div>
                                <div class="flex justify-between text-gray-600">
                                    <span>Tax (5%)</span>
                                    <span id="summary-tax">P0.00</span>
                                </div>
                                <div class="flex justify-between text-gray-900 font-bold text-xl">
                                    <span>Total</span>
                                    <span id="summary-total">P0.00</span>
                                </div>
                            </div>
                        </div>

                        <div class="mt-6">
                            <h3 class="text-lg font-semibold text-gray-800">How would you like to pay?</h3>
                            <div class="space-y-3 mt-4">
                                <button id="pay-cashless-btn" class="w-full py-4 bg-green-700 text-white font-bold rounded-lg shadow-lg text-lg btn">PAY CASHLESS</button>
                                <button id="pay-cash-btn" class="w-full py-4 bg-amber-500 text-green-900 font-bold rounded-lg shadow-lg text-lg btn">PAY WITH CASH</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="profile-screen" class="app-screen hidden">
                <div class="safe-area overflow-y-auto">
                    <div class="p-6 bg-white shadow">
                        <h1 class="text-3xl font-bold text-gray-900">My Profile</h1>
                    </div>
                    
                    <div class="flex flex-col items-center p-6 mt-6">
                        <img id="profile-img" src="" alt="Profile Picture" class="w-32 h-32 rounded-full border-4 border-green-700 shadow-lg">
                        <h2 id="profile-name" class="text-2xl font-bold text-gray-900 mt-4"></h2>
                        <p id="profile-email" class="text-lg text-gray-600"></p>
                        
                        <button data-target="logout" class="mt-8 w-full max-w-xs py-3 bg-red-500 text-white font-semibold rounded-lg shadow btn">Log Out</button>
                    </div>

                    <div class="px-6 mt-4">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Settings</h3>
                        <div class="space-y-2">
                            <button data-target="manage-account" class="w-full text-left p-4 bg-white rounded-lg shadow flex justify-between items-center btn">
                                <span class="font-medium text-gray-700">Manage Account</span>
                                <span class="text-gray-400">&rarr;</span>
                            </button>
                            <button data-target="payment-methods" class="w-full text-left p-4 bg-white rounded-lg shadow flex justify-between items-center btn">
                                <span class="font-medium text-gray-700">Payment Methods</span>
                                <span class="text-gray-400">&rarr;</span>
                            </button>
                            <button data-target="notifications" class="w-full text-left p-4 bg-white rounded-lg shadow flex justify-between items-center btn">
                                <span class="font-medium text-gray-700">Notifications</span>
                                <span class="text-gray-400">&rarr;</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="px-6 mt-8">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">(Demo) Switch User</h3>
                        <div id="user-switcher" class="space-y-2">
                        </div>
                    </div>
                </div>
            </section>

            <section id="manage-account-screen" class="app-screen hidden bg-white">
                <div class="safe-area overflow-y-auto p-6">
                    <button class="profile-back-btn text-green-700 btn">&larr; Back to Profile</button>
                    <h1 class="text-3xl font-bold text-gray-900 mt-4">Manage Account</h1>
                    <p class="text-lg text-gray-600 mt-4">This is a placeholder page for managing your account details.</p>
                </div>
            </section>

            <section id="payment-methods-screen" class="app-screen hidden bg-white">
                <div class="safe-area overflow-y-auto p-6">
                    <button class="profile-back-btn text-green-700 btn">&larr; Back to Profile</button>
                    <h1 class="text-3xl font-bold text-gray-900 mt-4">Payment Methods</h1>
                    <p class="text-lg text-gray-600 mt-4">This is a placeholder page for adding or removing payment methods like GCash or credit cards.</p>
                </div>
            </section>

            <section id="notifications-screen" class="app-screen hidden bg-white">
                <div class="safe-area overflow-y-auto p-6">
                    <button class="profile-back-btn text-green-700 btn">&larr; Back to Profile</button>
                    <h1 class="text-3xl font-bold text-gray-900 mt-4">Notifications</h1>
                    <p class="text-lg text-gray-600 mt-4">This is a placeholder page for managing your notification preferences.</p>
                </div>
            </section>

            <section id="payment-screen" class="app-screen hidden bg-white">
                <div class="safe-area overflow-y-auto p-6">
                    <button id="payment-back-btn" class="text-green-700 btn">&larr; Back to Cart</button>
                    <h1 class="text-3xl font-bold text-gray-900 mt-4">Select Payment</h1>
                    <p class="text-lg text-gray-600">Choose your preferred cashless method.</p>
                    
                    <div class="space-y-4 mt-8">
                        <button class="payment-method-btn w-full p-6 bg-blue-500 text-white rounded-lg font-semibold text-xl shadow-md btn flex items-center justify-center space-x-3">
                            <span>üîµ</span>
                            <span>GCash</span>
                        </button>
                        <button class="payment-method-btn w-full p-6 bg-blue-700 text-white rounded-lg font-semibold text-xl shadow-md btn flex items-center justify-center space-x-3">
                            <span>üü£</span>
                            <span>Maya</span>
                        </button>
                        <button class="payment-method-btn w-full p-6 bg-gray-700 text-white rounded-lg font-semibold text-xl shadow-md btn flex items-center justify-center space-x-3">
                            <span>üí≥</span>
                            <span>Credit/Debit Card</span>
                        </button>
                    </div>
                </div>
            </section>

            <section id="receipt-screen" class="app-screen hidden bg-white">
                <div class="safe-area flex flex-col items-center justify-center p-6 text-center">
                    <h1 class="text-3xl font-bold text-green-700">Thank You For Shopping!</h1>
                    <p class="text-lg text-gray-600 mt-2">Your payment has successfully processed.</p>
                    
                    <div class="mt-8 p-4 bg-white border rounded-lg shadow-xl">
                        <canvas id="qr-code-canvas"></canvas>
                    </div>
                    <p class="text-gray-600 mt-4">Scan QR with your phone for a detailed receipt.</p>
                    
                    <p class="text-lg text-gray-800 mt-8">Order ID: <strong id="order-id" class="font-mono"></strong></p>

                    <button id="done-btn" class="mt-12 w-full max-w-xs py-4 bg-green-700 text-white font-bold rounded-lg shadow-lg text-lg btn">Done</button>
                </div>
            </section>

        </div>

        <nav id="bottom-nav" class="hidden absolute bottom-0 z-10 w-full max-w-lg bg-white border-t border-gray-200 shadow-2xl">
            <div class="flex justify-around h-16">
                <button class="nav-btn flex-1 flex flex-col items-center justify-center" data-target="home-screen" data-active="true">
                    <span class="text-2xl">üè†</span>
                    <span class="text-xs font-medium">Home</span>
                </button>
                <button class="nav-btn flex-1 flex flex-col items-center justify-center" data-target="scan-screen" data-active="false">
                    <span class="text-2xl">üîç</span>
                    <span class="text-xs font-medium">Scan</span>
                </button>
                <button class="nav-btn flex-1 flex flex-col items-center justify-center relative" data-target="cart-screen" data-active="false">
                    <span id="cart-badge" class="hidden absolute top-3 right-1/4 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
                    <span class="text-2xl">üõí</span>
                    <span class="text-xs font-medium">Cart</span>
                </button>
                <button class="nav-btn flex-1 flex flex-col items-center justify-center" data-target="profile-screen" data-active="false">
                    <span class="text-2xl">üë§</span>
                    <span class="text-xs font-medium">Profile</span>
                </button>
            </div>
        </nav>
    </div>
    
    <div id="receipt-details-screen" class="app-screen hidden w-full max-w-lg p-6">
        <div class="bg-white p-6 rounded-lg shadow-xl">
            <h1 class="text-3xl font-bold text-green-700 text-center">Pure Go Go</h1>
            <p class="text-center text-gray-600">Official Receipt</p>
            
            <div class="border-t border-b border-dashed border-gray-300 my-4 py-2">
                <div class="flex justify-between text-gray-700">
                    <span>Order ID:</span>
                    <span id="receipt-order-id" class="font-mono font-bold"></span>
                </div>
                <div class="flex justify-between text-gray-700">
                    <span>Date:</span>
                    <span id="receipt-date"></span>
                </div>
            </div>
            
            <h2 class="text-lg font-semibold text-gray-800 mb-2">Items Purchased</h2>
            <div id="receipt-items-list" class="space-y-2">
            </div>
            
            <div class="border-t border-gray-300 mt-4 pt-4 space-y-2">
                <div class="flex justify-between text-gray-600">
                    <span>Subtotal</span>
                    <span id="receipt-subtotal"></span>
                </div>
                <div class="flex justify-between text-gray-600">
                    <span>Tax (5%)</span>
                    <span id="receipt-tax"></span>
                </div>
                <div class="flex justify-between text-gray-900 font-bold text-xl">
                    <span>Total</span>
                    <span id="receipt-total"></span>
                </div>
            </div>
            
            <p class="text-center text-gray-500 text-sm mt-6">Thank you for shopping with Pure Go Go!</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const appData = {
                products: [
                    { id: 'P-001', barcode: '4800016001010', name: 'Purefoods Corne Beef 150g', price: 129.50, discount: '-10% OFF', img: 'https://placehold.co/100x100/E19898/FFFFFF?text=Beef' },
                    { id: 'P-002', barcode: '4800016003014', name: 'Nissin Yakisoba Original', price: 20.00, discount: '', img: 'https://placehold.co/100x100/F7C5A6/333333?text=Noodles' },
                    { id: 'P-003', barcode: '4801981123456', name: 'Coke 1.5L', price: 80.00, discount: '2 for P150', img: 'https://placehold.co/100x100/DD7373/FFFFFF?text=Coke' },
                    { id: 'P-004', barcode: '028400612260', name: "Lay's Classic Chips 184g", price: 155.00, discount: '', img: 'https://placehold.co/100x100/FFD700/333333?text=Chips' },
                    { id: 'P-005', barcode: '4800016005018', name: 'Gardenia Classic White Bread', price: 75.00, discount: '', img: 'https://placehold.co/100x100/EADDCD/333333?text=Bread' },
                    { id: 'P-006', barcode: '4800361333065', name: 'Century Tuna Flakes in Oil 180g', price: 52.00, discount: '', img: 'https://placehold.co/100x100/BDBDBD/333333?text=Tuna' },
                    { id: 'P-007', barcode: '4800016002017', name: 'Lucky Me! Beef Mami', price: 15.00, discount: '', img: 'https://placehold.co/100x100/D4A5A5/333333?text=Beef+Mami' },
                    { id: 'P-008', barcode: '4800016004011', name: 'Sprite 1.5L', price: 80.00, discount: '2 for P150', img: 'https://placehold.co/100x100/A2D2FF/333333?text=Sprite' },
                    { id: 'P-009', barcode: '4807770270018', name: 'Oishi Prawn Crackers 90g', price: 25.00, discount: '', img: 'https://placehold.co/100x100/FFB4A2/333333?text=Oishi' },
                    { id: 'P-010', barcode: '4800016006015', name: 'Marby Mamon Tostado', price: 40.00, discount: '', img: 'https://placehold.co/100x100/FFDDA1/333333?text=Mamon' },
                    { id: 'P-011', barcode: '039000027008', name: 'Spam Classic 340g', price: 180.50, discount: 'Hot Buy!', img: 'https://placehold.co/100x100/A2C4FF/333333?text=Spam' }
                ],
                categories: [
                    { name: "Canned Goods", img: "https://placehold.co/400x300/FADBD8/333333?text=Canned" },
                    { name: "Noodles", img: "https://placehold.co/400x300/F9E79F/333333?text=Noodles" },
                    { name: "Drinks", img: "https://placehold.co/400x300/D6EAF8/333333?text=Drinks" },
                    { name: "Snacks", img: "https://placehold.co/400x300/D5F5E3/333333?text=Snacks" },
                    { name: "Bakery", img: "https://placehold.co/400x300/EBDEF0/333333?text=Bakery" },
                    { name: "Fresh Produce", img: "https://placehold.co/400x300/E8DAEF/333333?text=Fresh" }
                ],
                promotions: [
                    { title: "Holiday Super Sale", details: "Get up to 20% off!", img: "https://placehold.co/800x400/E3B9B7/FFFFFF?text=Holiday+Super+Sale" },
                    { title: "New User Discount", details: "Get P50 OFF your first purchase!", img: "https://placehold.co/800x400/B7E3B9/FFFFFF?text=New+User+Discount" },
                    { title: "Drink Deals", details: "Buy 2 1.5L Sodas and save P10!", img: "https://placehold.co/800x400/B9B7E3/FFFFFF?text=Drink+Deals" }
                ],
                users: [
                    { email: "leewen@example.com", name: "Leewen Jane Alday", img: "https://placehold.co/200x200/B7E3E1/333333?text=LJ" },
                    { email: "angelu@example.com", name: "Angelu Bordado", img: "https://placehold.co/200x200/E3B7B7/333333?text=AF" },
                    { email: "paul@example.com", name: "Paul Gilbert Dela Pe√±a", img: "https://placehold.co/200x200/B7C9E3/333333?text=PG" },
                    { email: "jamie@example.com", name: "Jamie Flores", img: "https://placehold.co/200x200/E3D1B7/333333?text=JF" }
                ],
                currentUser: null,
                cart: []
            };
            
            let html5QrCode = null;

            function initApp() {
                const params = new URLSearchParams(window.location.search);
                const receiptId = params.get('receipt');
                const receiptData = params.get('data');

                if (receiptId && receiptData) {
                    showReceiptDetails(receiptId, receiptData);
                } else {
                    appData.currentUser = appData.users[0];
                    initHome();
                    initProfile();
                    setTimeout(() => {
                        navigateTo('home-screen');
                    }, 2000);
                }
            }

            function initHome() {
                const user = appData.currentUser;
                document.getElementById('user-name-greeting').textContent = user.name.split(' ')[0] + '!';
                document.getElementById('home-profile-img').src = user.img;
                document.getElementById('home-profile-img').onclick = () => navigateTo('profile-screen');
                
                const promoContainer = document.getElementById('promotions-container');
                promoContainer.innerHTML = '';
                appData.promotions.forEach(promo => {
                    const promoEl = document.createElement('button');
                    promoEl.className = 'scroll-snap-item w-3/4 flex-shrink-0 btn text-left';
                    promoEl.innerHTML = `
                        <div class="h-32 bg-cover bg-center rounded-lg shadow-lg p-4 flex flex-col justify-end" style="background-image: url('${promo.img}')">
                            <h3 class="text-white font-bold text-lg" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${promo.title}</h3>
                            <p class="text-white text-sm" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${promo.details}</p>
                        </div>
                    `;
                    promoEl.onclick = () => {
                        navigateTo('scan-screen');
                        showToast(`Start scanning to get the "${promo.title}" deal!`, true);
                    };
                    promoContainer.appendChild(promoEl);
                });

                const catContainer = document.getElementById('categories-container');
                catContainer.innerHTML = '';
                appData.categories.forEach(cat => {
                    const catEl = document.createElement('button');
                    catEl.className = 'p-4 bg-white rounded-lg shadow-lg flex flex-col items-center justify-center aspect-square btn';
                    catEl.innerHTML = `
                        <img src="${cat.img}" alt="${cat.name}" class="w-16 h-12 object-cover rounded">
                        <span class="text-sm font-medium text-gray-700 mt-2 text-center">${cat.name}</span>
                    `;
                    catEl.onclick = () => {
                        navigateTo('scan-screen');
                        showToast(`Scanning for ${cat.name}...`, true);
                    };
                    catContainer.appendChild(catEl);
                });
            }

            function initProfile() {
                const user = appData.currentUser;
                document.getElementById('profile-img').src = user.img;
                document.getElementById('profile-name').textContent = user.name;
                document.getElementById('profile-email').textContent = user.email;
                
                document.querySelector('.btn[data-target="manage-account"]').onclick = () => navigateTo('manage-account-screen');
                document.querySelector('.btn[data-target="payment-methods"]').onclick = () => navigateTo('payment-methods-screen');
                document.querySelector('.btn[data-target="notifications"]').onclick = () => navigateTo('notifications-screen');
                document.querySelector('.btn[data-target="logout"]').onclick = () => {
                    appData.currentUser = appData.users[0];
                    initHome();
                    initProfile();
                    navigateTo('home-screen');
                    showToast('You have been logged out.', true);
                };

                const userSwitcher = document.getElementById('user-switcher');
                userSwitcher.innerHTML = '';
                appData.users.forEach(user => {
                    const isCurrentUser = user.email === appData.currentUser.email;
                    const userEl = document.createElement('button');
                    userEl.className = `w-full text-left p-4 bg-white rounded-lg shadow flex justify-between items-center btn ${isCurrentUser ? 'border-2 border-green-700' : ''}`;
                    userEl.dataset.email = user.email;
                    userEl.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <img src="${user.img}" class="w-10 h-10 rounded-full">
                            <div>
                                <span class="font-medium text-gray-700">${user.name}</span>
                                <span class="text-sm text-gray-500 block">${user.email}</span>
                            </div>
                        </div>
                        ${isCurrentUser ? '<span class="text-green-700 font-bold">Active</span>' : '<span class="text-gray-400">&rarr;</span>'}
                    `;
                    userEl.onclick = () => {
                        appData.currentUser = appData.users.find(u => u.email === user.email);
                        initHome();
                        initProfile();
                        showToast(`Switched to ${appData.currentUser.name}`, true);
                    };
                    userSwitcher.appendChild(userEl);
                });
            }
            
            const appContainer = document.getElementById('app-container');
            const receiptDetailsScreen = document.getElementById('receipt-details-screen');
            
            function showReceiptDetails(orderId, encodedData) {
                appContainer.classList.add('hidden');
                receiptDetailsScreen.classList.remove('hidden');
                
                try {
                    const decodedString = atob(encodedData);
                    const items = JSON.parse(decodedString);
                    
                    document.getElementById('receipt-order-id').textContent = orderId;
                    document.getElementById('receipt-date').textContent = new Date().toLocaleString('en-US');
                    
                    const receiptItemsList = document.getElementById('receipt-items-list');
                    receiptItemsList.innerHTML = '';
                    let subtotal = 0;
                    
                    items.forEach(item => {
                        const itemTotal = item.price * item.quantity;
                        subtotal += itemTotal;
                        const itemEl = document.createElement('div');
                        itemEl.className = 'flex justify-between items-center text-gray-800';
                        itemEl.innerHTML = `
                            <div>
                                <p class="font-medium">${item.name}</p>
                                <p class="text-sm text-gray-500">${item.quantity} x P${item.price.toFixed(2)}</p>
                            </div>
                            <span class="font-medium">P${itemTotal.toFixed(2)}</span>
                        `;
                        receiptItemsList.appendChild(itemEl);
                    });
                    
                    const tax = subtotal * 0.05;
                    const total = subtotal + tax;
                    
                    document.getElementById('receipt-subtotal').textContent = `P${subtotal.toFixed(2)}`;
                    document.getElementById('receipt-tax').textContent = `P${tax.toFixed(2)}`;
                    document.getElementById('receipt-total').textContent = `P${total.toFixed(2)}`;
                    
                } catch (e) {
                    receiptDetailsScreen.innerHTML = '<p class="text-red-500 text-center">Error: Could not decode receipt data.</p>';
                }
            }
            
            const appScreens = document.querySelectorAll('.app-screen');
            const navButtons = document.querySelectorAll('.nav-btn');
            const bottomNav = document.getElementById('bottom-nav');
            
            const cartItemsList = document.getElementById('cart-items-list');
            const emptyCartMsg = document.getElementById('empty-cart-msg');
            const cartSummaryBlock = document.getElementById('cart-summary-block');
            const clearCartBtn = document.getElementById('clear-cart-btn');
            const summarySubtotal = document.getElementById('summary-subtotal');
            const summaryTax = document.getElementById('summary-tax');
            const summaryTotal = document.getElementById('summary-total');
            const cartBadge = document.getElementById('cart-badge');
            
            const productInfoCard = document.getElementById('product-info-card');
            const scanError = document.getElementById('scan-error');
            let currentScannedProduct = null;

            function navigateTo(screenId) {
                if (html5QrCode && html5QrCode.isScanning) {
                    stopScanner();
                }
                
                appScreens.forEach(screen => {
                    screen.classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');

                const showNav = ['home-screen', 'scan-screen', 'cart-screen', 'profile-screen'].includes(screenId);
                bottomNav.classList.toggle('hidden', !showNav);

                navButtons.forEach(btn => {
                    btn.dataset.active = (btn.dataset.target === screenId).toString();
                });
                
                if (screenId === 'cart-screen') {
                    renderCart();
                }
            }

            function showToast(message, isUpdate) {
                const toast = document.getElementById('app-toast');
                const content = document.getElementById('app-toast-content');
                content.textContent = message;
                
                if (isUpdate) {
                    content.className = "w-full bg-blue-600 text-white text-center p-3 rounded-lg shadow-lg";
                } else {
                    content.className = "w-full bg-green-700 text-white text-center p-3 rounded-lg shadow-lg";
                }

                toast.classList.remove('hidden', 'toast-out');
                toast.classList.add('toast-in');
                
                setTimeout(() => {
                    toast.classList.remove('toast-in');
                    toast.classList.add('toast-out');
                }, 2000);
            }
            
            function startScanner() {
                const scannerRegion = document.getElementById('scanner-region');
                scannerRegion.innerHTML = '';
                const scannerBtn = document.getElementById('scanner-toggle-btn');
                
                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode("scanner-region");
                }

                if (html5QrCode.isScanning) {
                    stopScanner();
                    return;
                }

                scannerBtn.disabled = true;
                scannerBtn.textContent = 'Starting Camera...';

                html5QrCode.start(
                    { facingMode: "environment" },
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 150 }
                    },
                    (decodedText, decodedResult) => {
                        stopScanner();
                        document.getElementById('barcode-input').value = decodedText;
                        const product = findProductByBarcode(decodedText);
                        showProductInfo(product);
                        showToast('Barcode Scanned!', true);
                    },
                    (errorMessage) => {
                        // console.warn(`QR error: ${errorMessage}`);
                    })
                .then(() => {
                    scannerBtn.textContent = 'Stop Scanner';
                    scannerBtn.disabled = false;
                    scannerBtn.classList.add('bg-red-500');
                    scannerBtn.classList.remove('bg-green-700');
                })
                .catch(err => {
                    scannerRegion.innerHTML = `<span class="text-red-400 p-4 text-center">Error: ${err}. Please grant camera permission.</span>`;
                    scannerBtn.textContent = 'Start Scanner';
                    scannerBtn.disabled = false;
                });
            }

            function stopScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {
                        const scannerBtn = document.getElementById('scanner-toggle-btn');
                        scannerBtn.textContent = 'Start Scanner';
                        scannerBtn.disabled = false;
                        scannerBtn.classList.remove('bg-red-500');
                        scannerBtn.classList.add('bg-green-700');
                        document.getElementById('scanner-region').innerHTML = '<span classax="text-gray-400">Tap to start scanner</span>';
                    }).catch(err => console.error("Scanner stop error", err));
                }
            }

            document.getElementById('scanner-toggle-btn').addEventListener('click', () => {
                if (html5QrCode && html5QrCode.isScanning) {
                    stopScanner();
                } else {
                    startScanner();
                }
            });


            function findProductByBarcode(barcode) {
                return appData.products.find(p => p.barcode === barcode);
            }
            
            function showProductInfo(product) {
                const inputEl = document.getElementById('barcode-input');
                if (!product) {
                    productInfoCard.classList.add('hidden');
                    scanError.classList.remove('hidden');
                    scanError.classList.add('animate-shake');
                    setTimeout(() => scanError.classList.remove('animate-shake'), 300);
                    currentScannedProduct = null;
                    return;
                }
                
                scanError.classList.add('hidden');
                document.getElementById('product-img').src = product.img;
                document.getElementById('product-name').textContent = product.name;
                document.getElementById('product-price').textContent = `P${product.price.toFixed(2)}`;
                const discountEl = document.getElementById('product-discount');
                discountEl.textContent = product.discount;
                discountEl.classList.toggle('hidden', !product.discount);
                
                currentScannedProduct = product;
                productInfoCard.classList.remove('hidden');
            }
            
            function addItemToCart(product) {
                if (!product) return;
                
                const existingItem = appData.cart.find(item => item.id === product.id);
                
                if (existingItem) {
                    existingItem.quantity++;
                    showToast(`${product.name} quantity updated!`, true);
                } else {
                    appData.cart.push({ ...product, quantity: 1 });
                    showToast(`${product.name} added to cart!`, false);
                }
                
                productInfoCard.classList.add('hidden');
                currentScannedProduct = null;
                document.getElementById('barcode-input').value = '';
                
                updateCartSummary();
            }
            
            function updateCartQuantity(productId, change) {
                const item = appData.cart.find(item => item.id === productId);
                if (item) {
                    item.quantity += change;
                    if (item.quantity <= 0) {
                        appData.cart = appData.cart.filter(item => item.id !== productId);
                    }
                }
                renderCart();
            }

            function renderCart() {
                cartItemsList.innerHTML = '';
                
                if (appData.cart.length === 0) {
                    cartItemsList.appendChild(emptyCartMsg);
                    emptyCartMsg.classList.remove('hidden');
                    cartSummaryBlock.classList.add('hidden');
                    clearCartBtn.classList.add('hidden');
                } else {
                    emptyCartMsg.classList.add('hidden');
                    cartSummaryBlock.classList.remove('hidden');
                    clearCartBtn.classList.remove('hidden');
                    
                    appData.cart.forEach(item => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'flex items-center space-x-4 p-3 bg-white border-b border-gray-200 fade-in';
                        itemEl.innerHTML = `
                            <img src="${item.img}" alt="${item.name}" class="w-16 h-16 rounded-lg bg-gray-100 object-cover">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-800">${item.name}</h3>
                                <p class="text-green-700 font-bold">P${(item.price * item.quantity).toFixed(2)}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="qty-btn w-7 h-7 bg-gray-200 rounded-full btn" data-id="${item.id}" data-change="-1">-</button>
                                <span class="font-bold w-6 text-center">${item.quantity}</span>
                                <button class="qty-btn w-7 h-7 bg-gray-200 rounded-full btn" data-id="${item.id}" data-change="1">+</button>
                            </div>
                        `;
                        cartItemsList.appendChild(itemEl);
                    });
                }
                
                cartItemsList.querySelectorAll('.qty-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        updateCartQuantity(btn.dataset.id, parseInt(btn.dataset.change));
                    });
                });
                
                updateCartSummary();
            }
            
            clearCartBtn.addEventListener('click', () => {
                appData.cart = [];
                renderCart();
            });

            function updateCartSummary() {
                const subtotal = appData.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                const tax = subtotal * 0.05;
                const total = subtotal + tax;
                
                summarySubtotal.textContent = `P${subtotal.toFixed(2)}`;
                summaryTax.textContent = `P${tax.toFixed(2)}`;
                summaryTotal.textContent = `P${total.toFixed(2)}`;
                
                const cartCount = appData.cart.reduce((sum, item) => sum + item.quantity, 0);
                cartBadge.textContent = cartCount;
                cartBadge.classList.toggle('hidden', cartCount === 0);
            }
            
            function generateReceipt() {
                const orderId = 'A' + Math.random().toString(36).substr(2, 8).toUpperCase();
                
                const cartString = JSON.stringify(appData.cart);
                const encodedCart = btoa(cartString);
                
                const baseUrl = window.location.href.split('?')[0];
                const receiptUrl = `${baseUrl}?receipt=${orderId}&data=${encodedCart}`;
                
                new QRious({
                    element: document.getElementById('qr-code-canvas'),
                    value: receiptUrl,
                    size: 150,
                    padding: 0
                });
                
                document.getElementById('order-id').textContent = orderId;
                navigateTo('receipt-screen');
            }
            
            function clearCartAndReset() {
                appData.cart = [];
                renderCart();
                navigateTo('home-screen');
            }

            navButtons.forEach(btn => {
                btn.addEventListener('click', () => navigateTo(btn.dataset.target));
            });
            
            document.getElementById('find-item-btn').addEventListener('click', () => {
                const barcode = document.getElementById('barcode-input').value;
                const product = findProductByBarcode(barcode);
                showProductInfo(product);
            });
            
            document.querySelectorAll('.quick-add-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const product = findProductByBarcode(btn.dataset.barcode);
                    showProductInfo(product);
                    document.getElementById('barcode-input').value = btn.dataset.barcode;
                });
            });

            document.getElementById('add-to-cart-btn').addEventListener('click', () => {
                addItemToCart(currentScannedProduct);
            });
            
            document.getElementById('empty-cart-scan-btn').addEventListener('click', () => {
                navigateTo('scan-screen');
            });
            
            document.getElementById('pay-cash-btn').addEventListener('click', generateReceipt);
            
            document.getElementById('pay-cashless-btn').addEventListener('click', () => {
                navigateTo('payment-screen');
            });
            
            document.getElementById('payment-back-btn').addEventListener('click', () => {
                navigateTo('cart-screen');
            });
            
            document.querySelectorAll('.payment-method-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const loadingText = document.getElementById('loading-text');
                    loadingText.textContent = 'Processing Payment...';
                    navigateTo('loading-screen');
                    
                    setTimeout(() => {
                        generateReceipt();
                        loadingText.textContent = 'Loading...';
                    }, 2500);
                });
            });
 
            document.getElementById('done-btn').addEventListener('click', clearCartAndReset);
 
            document.querySelectorAll('.profile-back-btn').forEach(btn => {
                btn.addEventListener('click', () => navigateTo('profile-screen'));
            });
 
             initApp();
         });
    </script>
</body>
</html>